// Generated by CoffeeScript 1.9.0
var BOOT_STATUS, IS_INIT, authFP, bootStatus, buildACL, close, init, insertDoc, insertDocs, insertShare, insertUser, isInit, java, jdbcJar, match, matchAll, plug, plugSelectDocsByDocID, plugSelectUsersByUserID, selectDocs, selectUsers;

java = require('java');

jdbcJar = './plug/plug_api.jar';

java.classpath.push(jdbcJar);

plug = java.newInstanceSync('org.cozy.plug.Plug');

IS_INIT = false;

BOOT_STATUS = 0;

isInit = function() {
  return IS_INIT;
};

bootStatus = function() {
  return BOOT_STATUS;
};

init = function(callback) {
  var timeoutProtect;
  timeoutProtect = setTimeout((function() {
    timeoutProtect = null;
    return callback({
      error: 'PlugDB timed out'
    });
  }), 30000);
  return plug.plugInit('/dev/ttyACM0', function(err, status) {
    if (timeoutProtect) {
      clearTimeout(timeoutProtect);
      if (err == null) {
        console.log('PlugDB is ready');
        IS_INIT = true;
        BOOT_STATUS = status;
      }
      return callback(err);
    }
  });
};

insertDocs = function(ids, callback) {
  var array;
  array = java.newArray('java.lang.String', ids);
  plug.plugInsertDocs(array, function(err) {
    callback(err);
  });
};

insertDoc = function(docid, shareid, userParams, callback) {
  return plug.plugInsertDoc(docid, shareid, userParams, function(err) {
    return callback(err);
  });
};

insertUser = function(userid, shareid, userParams, callback) {
  return plug.plugInsertUser(userid, shareid, userParams, function(err) {
    return callback(err);
  });
};

insertShare = function(shareid, description, callback) {
  return plug.plugInsertShare(shareid, description, function(err) {
    return callback(err);
  });
};

selectDocs = function(callback) {
  plug.plugSelectDocs(function(err, results) {
    callback(err, results);
  });
};

selectUsers = function(callback) {
  plug.plugSelectUsers(function(err, results) {
    callback(err, results);
  });
};

plugSelectDocsByDocID = function(docid, callback) {
  return plug.plugSelectDocsByDocID(docid, function(err, result) {
    return callback(err, result);
  });
};

plugSelectUsersByUserID = function(userid, callback) {
  return plug.plugSelectUsersByUserID(userid, function(err, result) {
    return callback(err, result);
  });
};

matchAll = function(matchingType, id, shareid, callback) {
  return plug.plugMatchAll(matchingType, id, shareid, function(err, tuples) {
    return buildACL(tuples, shareid, function(acl) {
      return callback(err, acl);
    });
  });
};

match = function(matchingType, id, shareid, callback) {
  return plug.plugMatch(matchingType, id, shareid, function(err, result) {
    return callback(err, result);
  });
};

buildACL = function(tuples, shareid, callback) {
  var res, tuple, userInArray, _i, _len;
  userInArray = function(array, userID) {
    var ar, _i, _len;
    if (array != null) {
      for (_i = 0, _len = array.length; _i < _len; _i++) {
        ar = array[_i];
        if (ar.userID === userID) {
          return true;
        }
      }
    }
    return false;
  };
  if (tuples != null) {
    res = {
      shareID: shareid,
      users: [],
      docIDs: []
    };
    for (_i = 0, _len = tuples.length; _i < _len; _i++) {
      tuple = tuples[_i];
      if (!userInArray(res.users, tuple[0])) {
        res.users.push({
          userID: tuple[0]
        });
      }
      if (!(res.users.length > 1)) {
        res.docIDs.push(tuple[1]);
      }
    }
    return callback(res);
  } else {
    return callback(null);
  }
};

close = function(callback) {
  console.log('go close');
  return plug.plugClose(function(err) {
    if (err) {
      return callback(err);
    } else {
      IS_INIT = false;
      return callback(null);
    }
  });
};

authFP = function(callback) {
  plug.plugFPAuthentication(function(err, authID) {
    callback(err, authID);
  });
};

exports.MATCH_USERS = 0;

exports.MATCH_DOCS = 1;

exports.isInit = isInit;

exports.bootStatus = bootStatus;

exports.init = init;

exports.insertDocs = insertDocs;

exports.insertDoc = insertDoc;

exports.insertUser = insertUser;

exports.insertShare = insertShare;

exports.selectDocs = selectDocs;

exports.selectUsers = selectUsers;

exports.plugSelectDocsByDocID = plugSelectDocsByDocID;

exports.plugSelectUsersByUserID = plugSelectUsersByUserID;

exports.matchAll = matchAll;

exports.match = match;

exports.close = close;

exports.authFP = authFP;
