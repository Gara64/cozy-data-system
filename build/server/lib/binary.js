// Generated by CoffeeScript 1.9.1
var db, log;

db = require('../helpers/db_connect_helper').db_connect();

log = require('printit')({
  prefix: 'binary'
});

module.exports.addBinary = function(doc, attachData, readStream, callback) {
  var attachFile, binary, name, ref;
  name = attachData.name;
  attachFile = (function(_this) {
    return function(binary) {
      var stream;
      stream = db.saveAttachment(binary, attachData, function(err, binDoc) {
        var bin, binList;
        if (err) {
          return log.error("" + (JSON.stringify(err)));
        } else {
          log.info("Binary " + name + " stored in Couchdb");
          bin = {
            id: binDoc.id,
            rev: binDoc.rev
          };
          binList = doc.binary || {};
          binList[name] = bin;
          return db.merge(doc._id, {
            binary: binList
          }, function(err) {
            if (err != null) {
              log.error(err);
            }
            return callback();
          });
        }
      });
      return readStream.pipe(stream);
    };
  })(this);
  if (((ref = doc.binary) != null ? ref[name] : void 0) != null) {
    return db.get(doc.binary[name].id, function(err, binary) {
      return attachFile(binary);
    });
  } else {
    binary = {
      docType: "Binary"
    };
    return db.save(binary, function(err, binary) {
      return attachFile(binary);
    });
  }
};
