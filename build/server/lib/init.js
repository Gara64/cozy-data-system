// Generated by CoffeeScript 1.9.0
var async, db, log;

log = require('printit')({
  date: true,
  prefix: 'lib/init'
});

db = require('../helpers/db_connect_helper').db_connect();

async = require('async');

exports.removeLostBinaries = function(callback) {
  return db.view('binary/all', (function(_this) {
    return function(err, binaries) {
      if (!err && binaries.length > 0) {
        return async.forEachSeries(binaries, function(binary, cb) {
          return db.view('binary/byDoc', {
            key: binary.id
          }, (function(_this) {
            return function(err, doc) {
              if (!err && doc.length === 0) {
                log.info("Remove binary " + binary.id);
                return db.get(binary.id, function(err, doc) {
                  if (!err && doc) {
                    return db.remove(doc._id, doc._rev, function(err, doc) {
                      if (err) {
                        log.error(err);
                      }
                      return cb();
                    });
                  } else {
                    if (err) {
                      log.error(err);
                    }
                    return cb();
                  }
                });
              } else {
                if (err) {
                  log.error(err);
                }
                return cb();
              }
            };
          })(this));
        }, callback);
      } else {
        if (err != null) {
          log.error(err);
        }
        return callback(err);
      }
    };
  })(this));
};
